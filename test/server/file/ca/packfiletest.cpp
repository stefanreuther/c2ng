/**
  *  \file test/server/file/ca/packfiletest.cpp
  *  \brief Test for server::file::ca::PackFile
  */

#include "server/file/ca/packfile.hpp"

#include "afl/io/constmemorystream.hpp"
#include "afl/io/filemapping.hpp"
#include "afl/io/internaldirectory.hpp"
#include "afl/test/testrunner.hpp"
#include "afl/except/fileproblemexception.hpp"
#include "afl/io/internalfilemapping.hpp"

using afl::base::Ptr;
using afl::base::Ref;
using afl::io::ConstMemoryStream;
using afl::io::FileMapping;
using afl::io::InternalDirectory;
using server::file::ca::ObjectId;

namespace {
    /*
     *  Plain file: a commit refering to a tree containing a single file, created with git.
     *  All three in plain encoding.
     */
    static const uint8_t PLAIN_INDEX_FILE[] = {
        0xff, 0x74, 0x4f, 0x63, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x15, 0xb8, 0x1f, 0xed, 0xbf, 0xef, 0x12, 0x34,
        0xab, 0x99, 0xcb, 0xbe, 0x51, 0x0a, 0x10, 0x13, 0xfa, 0x3f, 0xcc, 0x3c, 0x4c, 0xf5, 0xaa, 0x5f,
        0x9a, 0x64, 0x42, 0x63, 0xdb, 0xe3, 0xd6, 0xe7, 0x8b, 0xcb, 0xef, 0x45, 0x48, 0x7a, 0x80, 0x2c,
        0x6c, 0xc8, 0xfa, 0x1d, 0x7f, 0xf2, 0xf1, 0xc1, 0x89, 0xb0, 0x2a, 0xdb, 0x1b, 0xa1, 0x32, 0x82,
        0x03, 0x0e, 0xcb, 0x1e, 0x61, 0x9e, 0xbd, 0x4d, 0xe7, 0xd0, 0x2b, 0x13, 0x2e, 0x2d, 0x53, 0xe4,
        0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x84, 0x00, 0x00, 0x00, 0x93, 0xd8, 0x3b, 0xf3, 0xbb,
        0xe9, 0x2c, 0x48, 0x44, 0x41, 0xe3, 0xd4, 0x9b, 0xfb, 0x57, 0x6d, 0x67, 0x81, 0x82, 0xea, 0x15,
        0xef, 0x5f, 0x0f, 0x1f, 0x5e, 0x2e, 0x4a, 0xcf, 0x89, 0x4f, 0x96, 0xaa, 0xc1, 0xca, 0xd7, 0x28,
        0xf9, 0xfc, 0x3e, 0xa9
    };
    static const uint8_t PLAIN_PACK_FILE[] = {
        0x50, 0x41, 0x43, 0x4b, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x03, 0x96, 0x0a, 0x78, 0x9c,
        0x95, 0xcb, 0x41, 0x0a, 0xc2, 0x30, 0x10, 0x00, 0xc0, 0x7b, 0x5e, 0xb1, 0x77, 0x41, 0x76, 0x13,
        0x9b, 0x44, 0x90, 0xe2, 0x1b, 0xda, 0x17, 0x6c, 0x92, 0x8d, 0x06, 0x4c, 0x0b, 0x71, 0x0b, 0x3e,
        0x5f, 0xbf, 0xe0, 0x71, 0x0e, 0xa3, 0x43, 0x04, 0x7c, 0xce, 0xb1, 0x32, 0x95, 0x50, 0xab, 0xad,
        0x94, 0x29, 0x5e, 0x13, 0x5a, 0x2e, 0x89, 0x12, 0x93, 0xb3, 0xd1, 0xa2, 0x43, 0xc9, 0x89, 0xc4,
        0xf0, 0xa1, 0xcf, 0x7d, 0xc0, 0xaa, 0x52, 0x79, 0x83, 0x45, 0x7e, 0x94, 0x01, 0xb7, 0xb7, 0x0e,
        0x39, 0xee, 0x8f, 0xfe, 0x39, 0x17, 0x99, 0x81, 0x82, 0x9f, 0xfc, 0xe4, 0x82, 0xbb, 0xc0, 0x09,
        0x09, 0xd1, 0xe4, 0xbd, 0xf7, 0xa6, 0x2a, 0x7f, 0x47, 0xd3, 0xb6, 0xa6, 0x8d, 0x5f, 0xe6, 0x0b,
        0xf8, 0x90, 0x32, 0xfd, 0x36, 0x78, 0x9c, 0xcb, 0x48, 0xcc, 0xc9, 0xc9, 0xe7, 0x02, 0x00, 0x08,
        0x37, 0x02, 0x1b, 0xa4, 0x02, 0x78, 0x9c, 0x33, 0x34, 0x30, 0x30, 0x33, 0x31, 0x51, 0x28, 0x49,
        0x2d, 0x2e, 0xd1, 0x2b, 0xa9, 0x28, 0x61, 0xf0, 0xf9, 0xba, 0x2a, 0x7e, 0x56, 0x8a, 0x53, 0xf2,
        0xed, 0xc7, 0xd7, 0x9e, 0x77, 0x9f, 0x7e, 0xef, 0xea, 0x51, 0xd5, 0xa0, 0x03, 0x00, 0xfb, 0x44,
        0x0f, 0xfe, 0xd8, 0x3b, 0xf3, 0xbb, 0xe9, 0x2c, 0x48, 0x44, 0x41, 0xe3, 0xd4, 0x9b, 0xfb, 0x57,
        0x6d, 0x67, 0x81, 0x82, 0xea, 0x15
    };

    /*
     *  Delta file (using OFS_DELTA).
     *  Two commits containing a tree with a single file each,
     *  one version of the file derived from the other using delta encoding.
     *  Created with git.
     */
    static const uint8_t DELTA_INDEX_FILE[] = {
        0xff, 0x74, 0x4f, 0x63, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x06,
        0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06,
        0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06,
        0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06,
        0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06,
        0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06,
        0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x16, 0x8d, 0x29, 0x2b, 0x86, 0x9f, 0xe7, 0xf2,
        0xc6, 0x5f, 0xfe, 0xdc, 0x32, 0x40, 0x44, 0x81, 0xc6, 0x80, 0x1e, 0x37, 0x7f, 0x54, 0x31, 0xe3,
        0x9f, 0xfd, 0xb5, 0x33, 0x16, 0x48, 0xc3, 0x65, 0xc1, 0x7b, 0x2b, 0xe4, 0xf8, 0xb8, 0x7a, 0x51,
        0x92, 0x14, 0x39, 0x54, 0x27, 0xde, 0x27, 0x89, 0x35, 0x1d, 0x17, 0x4f, 0xa1, 0x37, 0x90, 0x5d,
        0xe1, 0x94, 0x50, 0xa6, 0x97, 0xf9, 0x30, 0x64, 0xd4, 0x7d, 0x3a, 0x24, 0xda, 0x81, 0x7a, 0xfd,
        0xbd, 0x6b, 0xe4, 0x01, 0x13, 0x95, 0x82, 0xe2, 0xe8, 0xd3, 0x43, 0x02, 0x23, 0x40, 0xb6, 0xf7,
        0x3f, 0x6b, 0xf6, 0x90, 0x51, 0x2c, 0x4c, 0x8c, 0x6b, 0x2e, 0x0f, 0x19, 0xe9, 0x5d, 0x7f, 0x96,
        0x43, 0xd2, 0x7f, 0x0d, 0xf5, 0x59, 0xb5, 0x0d, 0x6d, 0xc8, 0x44, 0xa1, 0x2f, 0xb9, 0xe4, 0xae,
        0x76, 0xd0, 0x16, 0x44, 0x6f, 0xca, 0xb9, 0x61, 0x7d, 0x97, 0xf3, 0xca, 0x06, 0x3a, 0x3a, 0x10,
        0x15, 0xd7, 0x99, 0x1c, 0xea, 0x84, 0xe2, 0xed, 0x00, 0x00, 0x02, 0xea, 0x00, 0x00, 0x02, 0x8c,
        0x00, 0x00, 0x00, 0xa4, 0x00, 0x00, 0x01, 0x21, 0x00, 0x00, 0x02, 0xbb, 0x00, 0x00, 0x00, 0x0c,
        0xd5, 0x2b, 0x43, 0xa7, 0xb7, 0x58, 0x2c, 0x2b, 0xdf, 0xad, 0x7c, 0x32, 0xbd, 0x6e, 0xb9, 0x9f,
        0xb9, 0x16, 0xf4, 0xa4, 0xbd, 0xae, 0x91, 0x0e, 0xa9, 0x72, 0x50, 0xfd, 0x61, 0x2a, 0x20, 0x75,
        0x3d, 0xdd, 0xfa, 0x65, 0x19, 0xbd, 0xe0, 0xf2
    };
    static const uint8_t DELTA_PACK_FILE[] = {
        0x50, 0x41, 0x43, 0x4b, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x06, 0x9c, 0x0d, 0x78, 0x9c,
        0x95, 0xcc, 0x41, 0x0e, 0xc2, 0x20, 0x10, 0x40, 0xd1, 0x3d, 0xa7, 0x98, 0xbd, 0x89, 0x61, 0x60,
        0x86, 0x81, 0xc4, 0x18, 0xcf, 0x60, 0x4f, 0x00, 0x65, 0x50, 0x17, 0x6d, 0x0d, 0xd2, 0xc4, 0xe3,
        0x6b, 0xe2, 0x09, 0x5c, 0xfe, 0xc5, 0xfb, 0xa3, 0xab, 0x82, 0x34, 0x26, 0x8f, 0xea, 0x53, 0x6b,
        0xb5, 0xb0, 0xf7, 0x18, 0x28, 0xce, 0x3e, 0xf0, 0x8c, 0x52, 0x5c, 0x51, 0x6a, 0xb1, 0x44, 0xc9,
        0x8c, 0xe6, 0x99, 0xbb, 0xae, 0x03, 0x92, 0x43, 0xf2, 0x89, 0xc9, 0x49, 0x55, 0x27, 0x31, 0x79,
        0xc6, 0x8a, 0x42, 0x2d, 0xa3, 0x97, 0x64, 0xb9, 0x2a, 0x26, 0x62, 0x9b, 0x83, 0xc9, 0xfb, 0xb8,
        0x6f, 0x1d, 0xa6, 0xa1, 0x2d, 0xaf, 0x70, 0xd5, 0x6f, 0x6a, 0x87, 0xd3, 0x6b, 0x74, 0xdd, 0x2f,
        0xb7, 0xe5, 0x7d, 0xac, 0x7a, 0x06, 0x94, 0xc0, 0x11, 0xad, 0xa3, 0x00, 0x07, 0x8b, 0xd6, 0x9a,
        0x79, 0x5b, 0x96, 0xc7, 0x18, 0xfa, 0x37, 0x34, 0x93, 0xce, 0xdb, 0x5a, 0xe1, 0x37, 0x30, 0x1f,
        0x6f, 0x6b, 0x40, 0xa4, 0x9b, 0x0a, 0x78, 0x9c, 0x95, 0xcc, 0x3d, 0x0a, 0xc3, 0x30, 0x0c, 0x40,
        0xe1, 0xdd, 0xa7, 0xd0, 0x5e, 0x28, 0xf2, 0x4f, 0x1c, 0x1b, 0x4a, 0xe8, 0x94, 0x03, 0xb4, 0x27,
        0x88, 0x1d, 0xa9, 0xcd, 0xe0, 0x06, 0x14, 0x05, 0x7a, 0xfc, 0x04, 0x7a, 0x82, 0x8e, 0x6f, 0xf8,
        0x9e, 0x0a, 0x11, 0x50, 0x9a, 0x7d, 0xf0, 0xe8, 0x9c, 0x0f, 0x58, 0x22, 0xf7, 0x9e, 0x63, 0xe1,
        0x98, 0xb1, 0xb3, 0xae, 0x86, 0x9a, 0x6a, 0x2c, 0x8e, 0x90, 0x6d, 0x36, 0xd3, 0xae, 0xef, 0x55,
        0xe0, 0xa9, 0xc4, 0xd3, 0x07, 0x1e, 0x74, 0x26, 0x09, 0xdc, 0x36, 0x15, 0xda, 0xef, 0xaf, 0xf6,
        0xbd, 0xce, 0x34, 0x80, 0xed, 0x63, 0x97, 0xec, 0x79, 0xcb, 0x70, 0x41, 0x8b, 0x68, 0xea, 0xda,
        0xda, 0xa2, 0x4a, 0x7f, 0x43, 0x33, 0x2e, 0xb2, 0x29, 0xfc, 0xbc, 0x39, 0x00, 0x59, 0x84, 0x33,
        0xb2, 0xbf, 0x27, 0x78, 0x9c, 0x5d, 0x52, 0x5b, 0x8a, 0xdd, 0x30, 0x0c, 0xfd, 0xf7, 0x2a, 0xb4,
        0x80, 0xe0, 0x4d, 0x74, 0x5a, 0x28, 0x94, 0x52, 0xe8, 0x0a, 0x74, 0x6d, 0x35, 0x23, 0x70, 0xec,
        0x8c, 0x64, 0xa5, 0xdb, 0xef, 0x71, 0x73, 0xfb, 0x84, 0x40, 0x64, 0x29, 0x3a, 0x2f, 0xe7, 0xd3,
        0x30, 0x39, 0x48, 0x4f, 0x8f, 0x83, 0xea, 0x68, 0xc3, 0xc8, 0x75, 0x12, 0x1f, 0x32, 0x37, 0x2a,
        0xa3, 0xbb, 0x94, 0x29, 0x33, 0xc4, 0x88, 0xab, 0x9e, 0xea, 0x45, 0xfb, 0x4e, 0xd2, 0x74, 0xe6,
        0xf4, 0x12, 0xea, 0xe4, 0x58, 0xbe, 0xd6, 0x79, 0xa3, 0x68, 0xd3, 0xb4, 0x88, 0xd3, 0x5a, 0xfd,
        0x26, 0x76, 0x48, 0x9f, 0x00, 0xe5, 0x28, 0x73, 0xd8, 0x46, 0xf6, 0x3a, 0x7a, 0x09, 0xa7, 0xc0,
        0xb4, 0xe9, 0x1e, 0x8d, 0x73, 0xfa, 0xf2, 0xca, 0x2e, 0xad, 0xa1, 0xcb, 0x93, 0xce, 0xb0, 0x58,
        0x80, 0xf5, 0x59, 0x95, 0x30, 0xc7, 0x4b, 0xb9, 0x44, 0x53, 0xcf, 0xe9, 0x6b, 0xf8, 0x29, 0xbd,
        0xaa, 0xbb, 0xfc, 0x81, 0x07, 0x06, 0x00, 0x50, 0x8a, 0xbf, 0x85, 0x80, 0x9a, 0xd8, 0x4a, 0xe4,
        0xf4, 0x11, 0xca, 0x6d, 0x2e, 0xb1, 0x4c, 0x5d, 0xbe, 0x03, 0x16, 0x9f, 0xf4, 0x22, 0x6b, 0xf2,
        0x8f, 0x2f, 0x88, 0xf9, 0x99, 0x80, 0x04, 0x8a, 0xc7, 0xc0, 0x0e, 0x0c, 0xec, 0xe2, 0x93, 0x7d,
        0xbb, 0x9d, 0xd1, 0xa8, 0x3a, 0x48, 0x8f, 0x53, 0xac, 0x2a, 0x08, 0xc4, 0x06, 0x46, 0xbf, 0x52,
        0x22, 0xe7, 0x5d, 0xe7, 0xda, 0xea, 0xd1, 0x0b, 0x1d, 0x4a, 0x5c, 0xc0, 0x08, 0x31, 0x50, 0x0c,
        0x2f, 0x7d, 0xf4, 0x3b, 0xdd, 0x9c, 0x3e, 0x47, 0x6b, 0xbc, 0xe2, 0xea, 0xd2, 0x79, 0x6d, 0xec,
        0xc6, 0x97, 0x56, 0xa6, 0x61, 0x45, 0x73, 0x7a, 0x17, 0xc6, 0x0f, 0x9d, 0x61, 0x37, 0x12, 0x43,
        0xf0, 0x0a, 0x15, 0x2b, 0x65, 0x18, 0xc8, 0x97, 0x9a, 0xed, 0x19, 0x27, 0x31, 0xaa, 0xa6, 0x6f,
        0x01, 0x3c, 0x46, 0xa0, 0x68, 0xe1, 0xc9, 0xe9, 0xfd, 0x54, 0x74, 0x7c, 0x54, 0x6e, 0xb8, 0x88,
        0x85, 0x0b, 0x2d, 0xe5, 0x77, 0xde, 0x4b, 0x10, 0x92, 0x06, 0x07, 0xae, 0x92, 0x2e, 0x9d, 0x2c,
        0x4f, 0x8f, 0x82, 0xcb, 0x3c, 0x46, 0xbd, 0x41, 0x65, 0xfe, 0x17, 0xeb, 0xa5, 0x97, 0x98, 0xf1,
        0xf3, 0x07, 0x59, 0x96, 0x96, 0xc4, 0x9c, 0x3e, 0x84, 0x17, 0xf9, 0xcb, 0xd0, 0xcd, 0x43, 0xda,
        0xe9, 0x94, 0x8a, 0x00, 0x5e, 0xc6, 0x62, 0x57, 0xc0, 0x58, 0x8d, 0xe5, 0xdc, 0xa7, 0x3e, 0xa2,
        0xa1, 0x6c, 0xfa, 0x40, 0x8e, 0x39, 0xfd, 0x00, 0xb4, 0xd2, 0xe8, 0x8d, 0xa4, 0x02, 0x78, 0x9c,
        0x33, 0x34, 0x30, 0x30, 0x33, 0x31, 0x51, 0x28, 0x49, 0x2d, 0x2e, 0xd1, 0x2b, 0xa9, 0x28, 0x61,
        0x98, 0xfe, 0xd3, 0x20, 0xe5, 0x4a, 0xad, 0x95, 0xca, 0xad, 0xc6, 0xaa, 0xbf, 0x7b, 0xb3, 0x9f,
        0x30, 0x0a, 0x4f, 0x6d, 0x7a, 0x04, 0x00, 0xf1, 0x1e, 0x0f, 0x5c, 0xa4, 0x02, 0x78, 0x9c, 0x33,
        0x34, 0x30, 0x30, 0x33, 0x31, 0x51, 0x28, 0x49, 0x2d, 0x2e, 0xd1, 0x2b, 0xa9, 0x28, 0x61, 0x10,
        0xeb, 0xd5, 0xd4, 0x6e, 0x9b, 0xff, 0xfc, 0xd3, 0xb1, 0xf8, 0x7f, 0x77, 0x8c, 0x1c, 0x5c, 0x1a,
        0x8f, 0x35, 0xc8, 0x99, 0x03, 0x00, 0xe7, 0xb7, 0x0e, 0x64, 0xea, 0x01, 0x82, 0x49, 0x78, 0x9c,
        0xfb, 0xcf, 0xd2, 0xc4, 0x3c, 0xe1, 0xba, 0x80, 0x6f, 0x62, 0x6a, 0x72, 0x6a, 0x5e, 0x62, 0xb1,
        0x42, 0x59, 0x66, 0x59, 0x6a, 0x51, 0x51, 0xe2, 0xc4, 0xf7, 0xb3, 0x01, 0x90, 0x80, 0x0b, 0x57,
        0xd5, 0x2b, 0x43, 0xa7, 0xb7, 0x58, 0x2c, 0x2b, 0xdf, 0xad, 0x7c, 0x32, 0xbd, 0x6e, 0xb9, 0x9f,
        0xb9, 0x16, 0xf4, 0xa4
    };

    /*
     *  Delta file (using REF_DELTA); same content as previous.
     *  Created using "git -c repack.UseDeltaBaseOffset=0 repack".
     */
    const uint8_t REF_INDEX_FILE[] = {
        0xff, 0x74, 0x4f, 0x63, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
        0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x06,
        0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06,
        0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06,
        0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06,
        0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06,
        0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06,
        0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x06, 0x16, 0x8d, 0x29, 0x2b, 0x86, 0x9f, 0xe7, 0xf2,
        0xc6, 0x5f, 0xfe, 0xdc, 0x32, 0x40, 0x44, 0x81, 0xc6, 0x80, 0x1e, 0x37, 0x7f, 0x54, 0x31, 0xe3,
        0x9f, 0xfd, 0xb5, 0x33, 0x16, 0x48, 0xc3, 0x65, 0xc1, 0x7b, 0x2b, 0xe4, 0xf8, 0xb8, 0x7a, 0x51,
        0x92, 0x14, 0x39, 0x54, 0x27, 0xde, 0x27, 0x89, 0x35, 0x1d, 0x17, 0x4f, 0xa1, 0x37, 0x90, 0x5d,
        0xe1, 0x94, 0x50, 0xa6, 0x97, 0xf9, 0x30, 0x64, 0xd4, 0x7d, 0x3a, 0x24, 0xda, 0x81, 0x7a, 0xfd,
        0xbd, 0x6b, 0xe4, 0x01, 0x13, 0x95, 0x82, 0xe2, 0xe8, 0xd3, 0x43, 0x02, 0x23, 0x40, 0xb6, 0xf7,
        0x3f, 0x6b, 0xf6, 0x90, 0x51, 0x2c, 0x4c, 0x8c, 0x6b, 0x2e, 0x0f, 0x19, 0xe9, 0x5d, 0x7f, 0x96,
        0x43, 0xd2, 0x7f, 0x0d, 0xf5, 0x59, 0xb5, 0x0d, 0x6d, 0xc8, 0x44, 0xa1, 0x2f, 0xb9, 0xe4, 0xae,
        0xeb, 0xd6, 0x75, 0xc5, 0x6f, 0xca, 0xb9, 0x61, 0x7d, 0x97, 0xf3, 0xca, 0x06, 0x3a, 0x3a, 0x10,
        0x15, 0xd7, 0x99, 0x1c, 0xea, 0x84, 0xe2, 0xed, 0x00, 0x00, 0x02, 0xea, 0x00, 0x00, 0x02, 0x8c,
        0x00, 0x00, 0x00, 0xa4, 0x00, 0x00, 0x01, 0x21, 0x00, 0x00, 0x02, 0xbb, 0x00, 0x00, 0x00, 0x0c,
        0xac, 0xf4, 0x5e, 0x7e, 0x44, 0x80, 0xd9, 0x85, 0x2d, 0x9a, 0xf3, 0x28, 0xc3, 0x01, 0x25, 0x56,
        0x76, 0xac, 0x28, 0xa4, 0x07, 0x14, 0xab, 0x99, 0xab, 0x9c, 0xb5, 0x27, 0x4b, 0xd0, 0x76, 0xb4,
        0xb5, 0x3b, 0xbe, 0x2e, 0x06, 0x67, 0x7a, 0x52
    };
    const uint8_t REF_PACK_FILE[] = {
        0x50, 0x41, 0x43, 0x4b, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x06, 0x9c, 0x0d, 0x78, 0x9c,
        0x95, 0xcc, 0x41, 0x0e, 0xc2, 0x20, 0x10, 0x40, 0xd1, 0x3d, 0xa7, 0x98, 0xbd, 0x89, 0x61, 0x60,
        0x86, 0x81, 0xc4, 0x18, 0xcf, 0x60, 0x4f, 0x00, 0x65, 0x50, 0x17, 0x6d, 0x0d, 0xd2, 0xc4, 0xe3,
        0x6b, 0xe2, 0x09, 0x5c, 0xfe, 0xc5, 0xfb, 0xa3, 0xab, 0x82, 0x34, 0x26, 0x8f, 0xea, 0x53, 0x6b,
        0xb5, 0xb0, 0xf7, 0x18, 0x28, 0xce, 0x3e, 0xf0, 0x8c, 0x52, 0x5c, 0x51, 0x6a, 0xb1, 0x44, 0xc9,
        0x8c, 0xe6, 0x99, 0xbb, 0xae, 0x03, 0x92, 0x43, 0xf2, 0x89, 0xc9, 0x49, 0x55, 0x27, 0x31, 0x79,
        0xc6, 0x8a, 0x42, 0x2d, 0xa3, 0x97, 0x64, 0xb9, 0x2a, 0x26, 0x62, 0x9b, 0x83, 0xc9, 0xfb, 0xb8,
        0x6f, 0x1d, 0xa6, 0xa1, 0x2d, 0xaf, 0x70, 0xd5, 0x6f, 0x6a, 0x87, 0xd3, 0x6b, 0x74, 0xdd, 0x2f,
        0xb7, 0xe5, 0x7d, 0xac, 0x7a, 0x06, 0x94, 0xc0, 0x11, 0xad, 0xa3, 0x00, 0x07, 0x8b, 0xd6, 0x9a,
        0x79, 0x5b, 0x96, 0xc7, 0x18, 0xfa, 0x37, 0x34, 0x93, 0xce, 0xdb, 0x5a, 0xe1, 0x37, 0x30, 0x1f,
        0x6f, 0x6b, 0x40, 0xa4, 0x9b, 0x0a, 0x78, 0x9c, 0x95, 0xcc, 0x3d, 0x0a, 0xc3, 0x30, 0x0c, 0x40,
        0xe1, 0xdd, 0xa7, 0xd0, 0x5e, 0x28, 0xf2, 0x4f, 0x1c, 0x1b, 0x4a, 0xe8, 0x94, 0x03, 0xb4, 0x27,
        0x88, 0x1d, 0xa9, 0xcd, 0xe0, 0x06, 0x14, 0x05, 0x7a, 0xfc, 0x04, 0x7a, 0x82, 0x8e, 0x6f, 0xf8,
        0x9e, 0x0a, 0x11, 0x50, 0x9a, 0x7d, 0xf0, 0xe8, 0x9c, 0x0f, 0x58, 0x22, 0xf7, 0x9e, 0x63, 0xe1,
        0x98, 0xb1, 0xb3, 0xae, 0x86, 0x9a, 0x6a, 0x2c, 0x8e, 0x90, 0x6d, 0x36, 0xd3, 0xae, 0xef, 0x55,
        0xe0, 0xa9, 0xc4, 0xd3, 0x07, 0x1e, 0x74, 0x26, 0x09, 0xdc, 0x36, 0x15, 0xda, 0xef, 0xaf, 0xf6,
        0xbd, 0xce, 0x34, 0x80, 0xed, 0x63, 0x97, 0xec, 0x79, 0xcb, 0x70, 0x41, 0x8b, 0x68, 0xea, 0xda,
        0xda, 0xa2, 0x4a, 0x7f, 0x43, 0x33, 0x2e, 0xb2, 0x29, 0xfc, 0xbc, 0x39, 0x00, 0x59, 0x84, 0x33,
        0xb2, 0xbf, 0x27, 0x78, 0x9c, 0x5d, 0x52, 0x5b, 0x8a, 0xdd, 0x30, 0x0c, 0xfd, 0xf7, 0x2a, 0xb4,
        0x80, 0xe0, 0x4d, 0x74, 0x5a, 0x28, 0x94, 0x52, 0xe8, 0x0a, 0x74, 0x6d, 0x35, 0x23, 0x70, 0xec,
        0x8c, 0x64, 0xa5, 0xdb, 0xef, 0x71, 0x73, 0xfb, 0x84, 0x40, 0x64, 0x29, 0x3a, 0x2f, 0xe7, 0xd3,
        0x30, 0x39, 0x48, 0x4f, 0x8f, 0x83, 0xea, 0x68, 0xc3, 0xc8, 0x75, 0x12, 0x1f, 0x32, 0x37, 0x2a,
        0xa3, 0xbb, 0x94, 0x29, 0x33, 0xc4, 0x88, 0xab, 0x9e, 0xea, 0x45, 0xfb, 0x4e, 0xd2, 0x74, 0xe6,
        0xf4, 0x12, 0xea, 0xe4, 0x58, 0xbe, 0xd6, 0x79, 0xa3, 0x68, 0xd3, 0xb4, 0x88, 0xd3, 0x5a, 0xfd,
        0x26, 0x76, 0x48, 0x9f, 0x00, 0xe5, 0x28, 0x73, 0xd8, 0x46, 0xf6, 0x3a, 0x7a, 0x09, 0xa7, 0xc0,
        0xb4, 0xe9, 0x1e, 0x8d, 0x73, 0xfa, 0xf2, 0xca, 0x2e, 0xad, 0xa1, 0xcb, 0x93, 0xce, 0xb0, 0x58,
        0x80, 0xf5, 0x59, 0x95, 0x30, 0xc7, 0x4b, 0xb9, 0x44, 0x53, 0xcf, 0xe9, 0x6b, 0xf8, 0x29, 0xbd,
        0xaa, 0xbb, 0xfc, 0x81, 0x07, 0x06, 0x00, 0x50, 0x8a, 0xbf, 0x85, 0x80, 0x9a, 0xd8, 0x4a, 0xe4,
        0xf4, 0x11, 0xca, 0x6d, 0x2e, 0xb1, 0x4c, 0x5d, 0xbe, 0x03, 0x16, 0x9f, 0xf4, 0x22, 0x6b, 0xf2,
        0x8f, 0x2f, 0x88, 0xf9, 0x99, 0x80, 0x04, 0x8a, 0xc7, 0xc0, 0x0e, 0x0c, 0xec, 0xe2, 0x93, 0x7d,
        0xbb, 0x9d, 0xd1, 0xa8, 0x3a, 0x48, 0x8f, 0x53, 0xac, 0x2a, 0x08, 0xc4, 0x06, 0x46, 0xbf, 0x52,
        0x22, 0xe7, 0x5d, 0xe7, 0xda, 0xea, 0xd1, 0x0b, 0x1d, 0x4a, 0x5c, 0xc0, 0x08, 0x31, 0x50, 0x0c,
        0x2f, 0x7d, 0xf4, 0x3b, 0xdd, 0x9c, 0x3e, 0x47, 0x6b, 0xbc, 0xe2, 0xea, 0xd2, 0x79, 0x6d, 0xec,
        0xc6, 0x97, 0x56, 0xa6, 0x61, 0x45, 0x73, 0x7a, 0x17, 0xc6, 0x0f, 0x9d, 0x61, 0x37, 0x12, 0x43,
        0xf0, 0x0a, 0x15, 0x2b, 0x65, 0x18, 0xc8, 0x97, 0x9a, 0xed, 0x19, 0x27, 0x31, 0xaa, 0xa6, 0x6f,
        0x01, 0x3c, 0x46, 0xa0, 0x68, 0xe1, 0xc9, 0xe9, 0xfd, 0x54, 0x74, 0x7c, 0x54, 0x6e, 0xb8, 0x88,
        0x85, 0x0b, 0x2d, 0xe5, 0x77, 0xde, 0x4b, 0x10, 0x92, 0x06, 0x07, 0xae, 0x92, 0x2e, 0x9d, 0x2c,
        0x4f, 0x8f, 0x82, 0xcb, 0x3c, 0x46, 0xbd, 0x41, 0x65, 0xfe, 0x17, 0xeb, 0xa5, 0x97, 0x98, 0xf1,
        0xf3, 0x07, 0x59, 0x96, 0x96, 0xc4, 0x9c, 0x3e, 0x84, 0x17, 0xf9, 0xcb, 0xd0, 0xcd, 0x43, 0xda,
        0xe9, 0x94, 0x8a, 0x00, 0x5e, 0xc6, 0x62, 0x57, 0xc0, 0x58, 0x8d, 0xe5, 0xdc, 0xa7, 0x3e, 0xa2,
        0xa1, 0x6c, 0xfa, 0x40, 0x8e, 0x39, 0xfd, 0x00, 0xb4, 0xd2, 0xe8, 0x8d, 0xa4, 0x02, 0x78, 0x9c,
        0x33, 0x34, 0x30, 0x30, 0x33, 0x31, 0x51, 0x28, 0x49, 0x2d, 0x2e, 0xd1, 0x2b, 0xa9, 0x28, 0x61,
        0x98, 0xfe, 0xd3, 0x20, 0xe5, 0x4a, 0xad, 0x95, 0xca, 0xad, 0xc6, 0xaa, 0xbf, 0x7b, 0xb3, 0x9f,
        0x30, 0x0a, 0x4f, 0x6d, 0x7a, 0x04, 0x00, 0xf1, 0x1e, 0x0f, 0x5c, 0xa4, 0x02, 0x78, 0x9c, 0x33,
        0x34, 0x30, 0x30, 0x33, 0x31, 0x51, 0x28, 0x49, 0x2d, 0x2e, 0xd1, 0x2b, 0xa9, 0x28, 0x61, 0x10,
        0xeb, 0xd5, 0xd4, 0x6e, 0x9b, 0xff, 0xfc, 0xd3, 0xb1, 0xf8, 0x7f, 0x77, 0x8c, 0x1c, 0x5c, 0x1a,
        0x8f, 0x35, 0xc8, 0x99, 0x03, 0x00, 0xe7, 0xb7, 0x0e, 0x64, 0xfa, 0x01, 0x97, 0xf9, 0x30, 0x64,
        0xd4, 0x7d, 0x3a, 0x24, 0xda, 0x81, 0x7a, 0xfd, 0xbd, 0x6b, 0xe4, 0x01, 0x13, 0x95, 0x82, 0xe2,
        0x78, 0x9c, 0xfb, 0xcf, 0xd2, 0xc4, 0x3c, 0xe1, 0xba, 0x80, 0x6f, 0x62, 0x6a, 0x72, 0x6a, 0x5e,
        0x62, 0xb1, 0x42, 0x59, 0x66, 0x59, 0x6a, 0x51, 0x51, 0xe2, 0xc4, 0xf7, 0xb3, 0x01, 0x90, 0x80,
        0x0b, 0x57, 0xac, 0xf4, 0x5e, 0x7e, 0x44, 0x80, 0xd9, 0x85, 0x2d, 0x9a, 0xf3, 0x28, 0xc3, 0x01,
        0x25, 0x56, 0x76, 0xac, 0x28, 0xa4
    };

    /*
     *  ObjectRequester implementation
     */
    class TestRequester : public server::file::ca::PackFile::ObjectRequester {
     public:
        TestRequester(server::file::ca::PackFile& parent)
            : m_parent(parent)
            { }
        Ref<FileMapping> getObject(const ObjectId& id, size_t level)
            {
                Ptr<FileMapping> result = m_parent.getObject(id, *this, level);
                if (result.get() == 0) {
                    throw afl::except::FileProblemException("<TestRequester>", "Bad reference");
                }
                return *result;
            }
     private:
        server::file::ca::PackFile& m_parent;
    };
}

/** Test access using normal (non-delta) objects. */
AFL_TEST("server.file.ca.PackFile:plain", a)
{
    Ref<InternalDirectory> dir = InternalDirectory::create("dir");
    dir->addStream("xy.pack", *new ConstMemoryStream(PLAIN_PACK_FILE));
    dir->addStream("xy.idx", *new ConstMemoryStream(PLAIN_INDEX_FILE));

    server::file::ca::PackFile testee(*dir, "xy");
    TestRequester req(testee);

    // Commit object
    {
        static const ObjectId objId = {{ 0x15, 0xb8, 0x1f, 0xed, 0xbf, 0xef, 0x12, 0x34, 0xab, 0x99, 0xcb, 0xbe, 0x51, 0x0a, 0x10, 0x13, 0xfa, 0x3f, 0xcc, 0x3c, }};
        Ptr<FileMapping> obj = testee.getObject(objId, req, 20);
        a.checkNonNull("obj 1 nonnull", obj.get());

        const char*const EXPECTED_CONTENT =
            "tree 6cc8fa1d7ff2f1c189b02adb1ba13282030ecb1e\n"
            "author Stefan Reuther <streu@gmx.de> 1765653734 +0100\n"
            "committer Stefan Reuther <streu@gmx.de> 1765653734 +0100\n"
            "\n"
            "initial\n";
        a.checkEqualContent("obj 1 content", obj->get(), afl::string::toBytes(EXPECTED_CONTENT));
    }

    // Tree object
    {
        static const ObjectId objId = {{ 0x6c, 0xc8, 0xfa, 0x1d, 0x7f, 0xf2, 0xf1, 0xc1, 0x89, 0xb0, 0x2a, 0xdb, 0x1b, 0xa1, 0x32, 0x82, 0x03, 0x0e, 0xcb, 0x1e, }};
        Ptr<FileMapping> obj = testee.getObject(objId, req, 20);
        a.checkNonNull("obj 2 nonnull", obj.get());

        static const uint8_t EXPECTED_CONTENT[] = {
            0x31, 0x30, 0x30, 0x36, 0x34, 0x34, 0x20, 0x74, 0x65, 0x73, 0x74, 0x2e, 0x74, 0x78, 0x74, 0x00,
            0x4c, 0xf5, 0xaa, 0x5f, 0x9a, 0x64, 0x42, 0x63, 0xdb, 0xe3, 0xd6, 0xe7, 0x8b, 0xcb, 0xef, 0x45,
            0x48, 0x7a, 0x80, 0x2c
        };
        a.checkEqualContent("obj 2 content", obj->get(), afl::base::ConstBytes_t(EXPECTED_CONTENT));
    }

    // Blob object
    {
        static const ObjectId objId = {{ 0x4c, 0xf5, 0xaa, 0x5f, 0x9a, 0x64, 0x42, 0x63, 0xdb, 0xe3, 0xd6, 0xe7, 0x8b, 0xcb, 0xef, 0x45, 0x48, 0x7a, 0x80, 0x2c, }};
        Ptr<FileMapping> obj = testee.getObject(objId, req, 20);
        a.checkNonNull("obj 3 nonnull", obj.get());

        const char*const EXPECTED_CONTENT =
            "hallo\n";
        a.checkEqualContent("obj 3 content", obj->get(), afl::string::toBytes(EXPECTED_CONTENT));
    }

    // Nonexistant
    {
        static const ObjectId objId = {{ 0x33, 0x33, 0x33, 0x5f, 0x9a, 0x64, 0x42, 0x63, 0xdb, 0xe3, 0xd6, 0xe7, 0x8b, 0xcb, 0xef, 0x45, 0x48, 0x7a, 0x80, 0x2c, }};
        Ptr<FileMapping> obj = testee.getObject(objId, req, 20);
        a.checkNull("obj 4 null", obj.get());
    }
}

namespace {
    /* Common verification for delta encoding */
    void verifyObjects(afl::test::Assert a, server::file::ca::PackFile& testee)
    {
        // Requesting objects in order of ID for some seeking...
        TestRequester req(testee);

        // Blob object #1 - this one uses delta encoding
        {
            static const ObjectId objId = {{ 0x16, 0x8d, 0x29, 0x2b, 0x86, 0x9f, 0xe7, 0xf2, 0xc6, 0x5f, 0xfe, 0xdc, 0x32, 0x40, 0x44, 0x81, 0xc6, 0x80, 0x1e, 0x37, }};
            Ptr<FileMapping> obj = testee.getObject(objId, req, 20);
            a.checkNonNull("obj 1 nonnull", obj.get());

            const char*const EXPECTED_CONTENT =
                "Lorem ipsum dolor sit amet, consectetuer adipiscing elit.\n"
                "Duis sem velit, ultrices et, fermentum auctor, rhoncus ut, ligula.\n"
                "Phasellus at purus sed purus cursus iaculis.\n"
                "Suspendisse fermentum.\n"
                "Pellentesque et arcu.\n"
                "Maecenas viverra.\n"
                "In consectetuer, lorem eu lobortis egestas, velit odio imperdiet eros, sit amet sagittis nunc mi ac neque.\n"
                "Sed non ipsum.\n"
                "Nullam venenatis gravida orci.\n";
            a.checkEqualContent("obj 1 content", obj->get(), afl::string::toBytes(EXPECTED_CONTENT));
        }

        // Tree object #2
        {
            static const ObjectId objId = {{ 0x7f, 0x54, 0x31, 0xe3, 0x9f, 0xfd, 0xb5, 0x33, 0x16, 0x48, 0xc3, 0x65, 0xc1, 0x7b, 0x2b, 0xe4, 0xf8, 0xb8, 0x7a, 0x51, }};
            Ptr<FileMapping> obj = testee.getObject(objId, req, 20);
            a.checkNonNull("obj 2 nonnull", obj.get());

            static const uint8_t EXPECTED_CONTENT[] = {
                0x31, 0x30, 0x30, 0x36, 0x34, 0x34, 0x20, 0x74, 0x65, 0x73, 0x74, 0x2e, 0x74, 0x78, 0x74, 0x00,
                0x97, 0xf9, 0x30, 0x64, 0xd4, 0x7d, 0x3a, 0x24, 0xda, 0x81, 0x7a, 0xfd, 0xbd, 0x6b, 0xe4, 0x01,
                0x13, 0x95, 0x82, 0xe2
            };
            a.checkEqualContent("obj 2 content", obj->get(), afl::base::ConstBytes_t(EXPECTED_CONTENT));
        }

        // Commit object #1
        {
            static const ObjectId objId = {{ 0x92, 0x14, 0x39, 0x54, 0x27, 0xde, 0x27, 0x89, 0x35, 0x1d, 0x17, 0x4f, 0xa1, 0x37, 0x90, 0x5d, 0xe1, 0x94, 0x50, 0xa6, }};
            Ptr<FileMapping> obj = testee.getObject(objId, req, 20);
            a.checkNonNull("obj 3 nonnull", obj.get());

            const char*const EXPECTED_CONTENT =
                "tree e8d343022340b6f73f6bf690512c4c8c6b2e0f19\n"
                "author Stefan Reuther <streu@gmx.de> 1765810229 +0100\n"
                "committer Stefan Reuther <streu@gmx.de> 1765810229 +0100\n"
                "\n"
                "First commit\n";
            a.checkEqualContent("obj 3 content", obj->get(), afl::string::toBytes(EXPECTED_CONTENT));
        }

        // Blob object #2
        {
            static const ObjectId objId = {{ 0x97, 0xf9, 0x30, 0x64, 0xd4, 0x7d, 0x3a, 0x24, 0xda, 0x81, 0x7a, 0xfd, 0xbd, 0x6b, 0xe4, 0x01, 0x13, 0x95, 0x82, 0xe2, }};
            Ptr<FileMapping> obj = testee.getObject(objId, req, 20);
            a.checkNonNull("obj 4 nonnull", obj.get());

            const char*const EXPECTED_CONTENT =
                "Lorem ipsum dolor sit amet, consectetuer adipiscing elit.\n"
                "Duis sem velit, ultrices et, fermentum auctor, rhoncus ut, ligula.\n"
                "Phasellus at purus sed purus cursus iaculis.\n"
                "Suspendisse fermentum.\n"
                "Pellentesque et arcu.\n"
                "Inserting a new sentence.\n"
                "In consectetuer, lorem eu lobortis egestas, velit odio imperdiet eros, sit amet sagittis nunc mi ac neque.\n"
                "Sed non ipsum.\n"
                "Nullam venenatis gravida orci.\n"
                "Curabitur nunc ante, ullamcorper vel, auctor a, aliquam at, tortor.\n"
                "Etiam sodales orci nec ligula.\n"
                "Sed at turpis vitae velit euismod aliquet.\n"
                "Pellentesque viverra dolor non nunc.\n"
                "Fusce venenatis ligula in pede.\n"
                "Donec interdum vestibulum libero.\n";
            a.checkEqualContent("obj 4 content", obj->get(), afl::string::toBytes(EXPECTED_CONTENT));
        }

        // Tree object #1
        {
            static const ObjectId objId = {{ 0xe8, 0xd3, 0x43, 0x02, 0x23, 0x40, 0xb6, 0xf7, 0x3f, 0x6b, 0xf6, 0x90, 0x51, 0x2c, 0x4c, 0x8c, 0x6b, 0x2e, 0x0f, 0x19, }};
            Ptr<FileMapping> obj = testee.getObject(objId, req, 20);
            a.checkNonNull("obj 5 nonnull", obj.get());

            static const uint8_t EXPECTED_CONTENT[] = {
                0x31, 0x30, 0x30, 0x36, 0x34, 0x34, 0x20, 0x74, 0x65, 0x73, 0x74, 0x2e, 0x74, 0x78, 0x74, 0x00,
                0x16, 0x8d, 0x29, 0x2b, 0x86, 0x9f, 0xe7, 0xf2, 0xc6, 0x5f, 0xfe, 0xdc, 0x32, 0x40, 0x44, 0x81,
                0xc6, 0x80, 0x1e, 0x37
            };
            a.checkEqualContent("obj 5 content", obj->get(), afl::base::ConstBytes_t(EXPECTED_CONTENT));
        }

        // Commit object #2
        {
            static const ObjectId objId = {{ 0xe9, 0x5d, 0x7f, 0x96, 0x43, 0xd2, 0x7f, 0x0d, 0xf5, 0x59, 0xb5, 0x0d, 0x6d, 0xc8, 0x44, 0xa1, 0x2f, 0xb9, 0xe4, 0xae,  }};
            Ptr<FileMapping> obj = testee.getObject(objId, req, 20);
            a.checkNonNull("obj 6 nonnull", obj.get());

            const char*const EXPECTED_CONTENT =
                "tree 7f5431e39ffdb5331648c365c17b2be4f8b87a51\n"
                "parent 9214395427de2789351d174fa137905de19450a6\n"
                "author Stefan Reuther <streu@gmx.de> 1765810246 +0100\n"
                "committer Stefan Reuther <streu@gmx.de> 1765810246 +0100\n"
                "\n"
                "Second commit\n";
            a.checkEqualContent("obj 6 content", obj->get(), afl::string::toBytes(EXPECTED_CONTENT));
        }
    }

    /* Common verification for disabled reference chasing */
    void verifyDisabledReferences(afl::test::Assert a, server::file::ca::PackFile& testee)
    {
        TestRequester req(testee);
        {
            static const ObjectId objId = {{ 0x16, 0x8d, 0x29, 0x2b, 0x86, 0x9f, 0xe7, 0xf2, 0xc6, 0x5f, 0xfe, 0xdc, 0x32, 0x40, 0x44, 0x81, 0xc6, 0x80, 0x1e, 0x37, }};
            AFL_CHECK_THROWS(a("getObject 1"), testee.getObject(objId, req, 0), afl::except::FileProblemException);
        }
        {
            static const ObjectId objId = {{ 0x7f, 0x54, 0x31, 0xe3, 0x9f, 0xfd, 0xb5, 0x33, 0x16, 0x48, 0xc3, 0x65, 0xc1, 0x7b, 0x2b, 0xe4, 0xf8, 0xb8, 0x7a, 0x51, }};
            AFL_CHECK_SUCCEEDS(a("getObject 2"), testee.getObject(objId, req, 0));
        }
    }
}

/** Test access using delta-encoded objects. */
AFL_TEST("server.file.ca.PackFile:delta", a)
{
    Ref<InternalDirectory> dir = InternalDirectory::create("dir");
    dir->addStream("xy.pack", *new ConstMemoryStream(DELTA_PACK_FILE));
    dir->addStream("xy.idx", *new ConstMemoryStream(DELTA_INDEX_FILE));

    server::file::ca::PackFile testee(*dir, "xy");
    verifyObjects(a, testee);
}

/** Test case using delta-encoded objects, disabled reference chasing. */
AFL_TEST("server.file.ca.PackFile:delta:error", a)
{
    Ref<InternalDirectory> dir = InternalDirectory::create("dir");
    dir->addStream("xy.pack", *new ConstMemoryStream(DELTA_PACK_FILE));
    dir->addStream("xy.idx", *new ConstMemoryStream(DELTA_INDEX_FILE));

    server::file::ca::PackFile testee(*dir, "xy");
    verifyDisabledReferences(a, testee);
}

/** Test access using delta-encoded objects using object references. */
AFL_TEST("server.file.ca.PackFile:ref", a)
{
    Ref<InternalDirectory> dir = InternalDirectory::create("dir");
    dir->addStream("xy.pack", *new ConstMemoryStream(REF_PACK_FILE));
    dir->addStream("xy.idx", *new ConstMemoryStream(REF_INDEX_FILE));

    server::file::ca::PackFile testee(*dir, "xy");
    verifyObjects(a, testee);
}

/** Test access using delta-encoded objects, disabled reference chasing. */
AFL_TEST("server.file.ca.PackFile:ref:error", a)
{
    Ref<InternalDirectory> dir = InternalDirectory::create("dir");
    dir->addStream("xy.pack", *new ConstMemoryStream(REF_PACK_FILE));
    dir->addStream("xy.idx", *new ConstMemoryStream(REF_INDEX_FILE));

    server::file::ca::PackFile testee(*dir, "xy");
    verifyDisabledReferences(a, testee);
}

/** Error case: length/compression mismatch.
    Modified the type-and-compression field such that it does no longer match the size of the compressed stream.
    Unpacker must detect the mismatch (inflater will stop consuming input and producing output). */
AFL_TEST("server.file.ca.PackFile:error:length-compression-mismatch", a)
{
    static const uint8_t PACK_FILE[] = {
        //                                                                             vvv modified
        0x50, 0x41, 0x43, 0x4b, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x03, 0x96, 0x7f, 0x78, 0x9c,
        0x95, 0xcb, 0x41, 0x0a, 0xc2, 0x30, 0x10, 0x00, 0xc0, 0x7b, 0x5e, 0xb1, 0x77, 0x41, 0x76, 0x13,
        0x9b, 0x44, 0x90, 0xe2, 0x1b, 0xda, 0x17, 0x6c, 0x92, 0x8d, 0x06, 0x4c, 0x0b, 0x71, 0x0b, 0x3e,
        0x5f, 0xbf, 0xe0, 0x71, 0x0e, 0xa3, 0x43, 0x04, 0x7c, 0xce, 0xb1, 0x32, 0x95, 0x50, 0xab, 0xad,
        0x94, 0x29, 0x5e, 0x13, 0x5a, 0x2e, 0x89, 0x12, 0x93, 0xb3, 0xd1, 0xa2, 0x43, 0xc9, 0x89, 0xc4,
        0xf0, 0xa1, 0xcf, 0x7d, 0xc0, 0xaa, 0x52, 0x79, 0x83, 0x45, 0x7e, 0x94, 0x01, 0xb7, 0xb7, 0x0e,
        0x39, 0xee, 0x8f, 0xfe, 0x39, 0x17, 0x99, 0x81, 0x82, 0x9f, 0xfc, 0xe4, 0x82, 0xbb, 0xc0, 0x09,
        0x09, 0xd1, 0xe4, 0xbd, 0xf7, 0xa6, 0x2a, 0x7f, 0x47, 0xd3, 0xb6, 0xa6, 0x8d, 0x5f, 0xe6, 0x0b,
        0xf8, 0x90, 0x32, 0xfd, /*0x36, 0x78, 0x9c, 0xcb, 0x48, 0xcc, 0xc9, 0xc9, 0xe7, 0x02, 0x00, 0x08, <-- data of unreferenced objects
        0x37, 0x02, 0x1b, 0xa4, 0x02, 0x78, 0x9c, 0x33, 0x34, 0x30, 0x30, 0x33, 0x31, 0x51, 0x28, 0x49,
        0x2d, 0x2e, 0xd1, 0x2b, 0xa9, 0x28, 0x61, 0xf0, 0xf9, 0xba, 0x2a, 0x7e, 0x56, 0x8a, 0x53, 0xf2,
        0xed, 0xc7, 0xd7, 0x9e, 0x77, 0x9f, 0x7e, 0xef, 0xea, 0x51, 0xd5, 0xa0, 0x03, 0x00, 0xfb, 0x44,
        0x0f, 0xfe,*/ 0xd8, 0x3b, 0xf3, 0xbb, 0xe9, 0x2c, 0x48, 0x44, 0x41, 0xe3, 0xd4, 0x9b, 0xfb, 0x57,
        0x6d, 0x67, 0x81, 0x82, 0xea, 0x15
    };

    Ref<InternalDirectory> dir = InternalDirectory::create("dir");
    dir->addStream("xy.pack", *new ConstMemoryStream(PACK_FILE));
    dir->addStream("xy.idx", *new ConstMemoryStream(PLAIN_INDEX_FILE));

    server::file::ca::PackFile testee(*dir, "xy");
    TestRequester req(testee);

    static const ObjectId objId = {{ 0x15, 0xb8, 0x1f, 0xed, 0xbf, 0xef, 0x12, 0x34, 0xab, 0x99, 0xcb, 0xbe, 0x51, 0x0a, 0x10, 0x13, 0xfa, 0x3f, 0xcc, 0x3c, }};
    AFL_CHECK_THROWS(a, testee.getObject(objId, req, 20), afl::except::FileProblemException);
}

/** Error case: bad type. */
AFL_TEST("server.file.ca.PackFile:error:bad-type", a)
{
    static const uint8_t PACK_FILE[] = {
        //                                                                       vvv modified
        0x50, 0x41, 0x43, 0x4b, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x03, 0x00, 0x7f, 0x78, 0x9c,
        0x95, 0xcb, 0x41, 0x0a, 0xc2, 0x30, 0x10, 0x00, 0xc0, 0x7b, 0x5e, 0xb1, 0x77, 0x41, 0x76, 0x13,
        0x9b, 0x44, 0x90, 0xe2, 0x1b, 0xda, 0x17, 0x6c, 0x92, 0x8d, 0x06, 0x4c, 0x0b, 0x71, 0x0b, 0x3e,
        0x5f, 0xbf, 0xe0, 0x71, 0x0e, 0xa3, 0x43, 0x04, 0x7c, 0xce, 0xb1, 0x32, 0x95, 0x50, 0xab, 0xad,
        0x94, 0x29, 0x5e, 0x13, 0x5a, 0x2e, 0x89, 0x12, 0x93, 0xb3, 0xd1, 0xa2, 0x43, 0xc9, 0x89, 0xc4,
        0xf0, 0xa1, 0xcf, 0x7d, 0xc0, 0xaa, 0x52, 0x79, 0x83, 0x45, 0x7e, 0x94, 0x01, 0xb7, 0xb7, 0x0e,
        0x39, 0xee, 0x8f, 0xfe, 0x39, 0x17, 0x99, 0x81, 0x82, 0x9f, 0xfc, 0xe4, 0x82, 0xbb, 0xc0, 0x09,
        0x09, 0xd1, 0xe4, 0xbd, 0xf7, 0xa6, 0x2a, 0x7f, 0x47, 0xd3, 0xb6, 0xa6, 0x8d, 0x5f, 0xe6, 0x0b,
        0xf8, 0x90, 0x32, 0xfd, /*0x36, 0x78, 0x9c, 0xcb, 0x48, 0xcc, 0xc9, 0xc9, 0xe7, 0x02, 0x00, 0x08, <-- data of unreferenced objects
        0x37, 0x02, 0x1b, 0xa4, 0x02, 0x78, 0x9c, 0x33, 0x34, 0x30, 0x30, 0x33, 0x31, 0x51, 0x28, 0x49,
        0x2d, 0x2e, 0xd1, 0x2b, 0xa9, 0x28, 0x61, 0xf0, 0xf9, 0xba, 0x2a, 0x7e, 0x56, 0x8a, 0x53, 0xf2,
        0xed, 0xc7, 0xd7, 0x9e, 0x77, 0x9f, 0x7e, 0xef, 0xea, 0x51, 0xd5, 0xa0, 0x03, 0x00, 0xfb, 0x44,
        0x0f, 0xfe,*/ 0xd8, 0x3b, 0xf3, 0xbb, 0xe9, 0x2c, 0x48, 0x44, 0x41, 0xe3, 0xd4, 0x9b, 0xfb, 0x57,
        0x6d, 0x67, 0x81, 0x82, 0xea, 0x15
    };

    Ref<InternalDirectory> dir = InternalDirectory::create("dir");
    dir->addStream("xy.pack", *new ConstMemoryStream(PACK_FILE));
    dir->addStream("xy.idx", *new ConstMemoryStream(PLAIN_INDEX_FILE));

    server::file::ca::PackFile testee(*dir, "xy");
    TestRequester req(testee);

    static const ObjectId objId = {{ 0x15, 0xb8, 0x1f, 0xed, 0xbf, 0xef, 0x12, 0x34, 0xab, 0x99, 0xcb, 0xbe, 0x51, 0x0a, 0x10, 0x13, 0xfa, 0x3f, 0xcc, 0x3c, }};
    AFL_CHECK_THROWS(a, testee.getObject(objId, req, 20), afl::except::FileProblemException);
}

/** Error case: bad data/truncated. */
AFL_TEST("server.file.ca.PackFile:error:bad-truncated", a)
{
    static const uint8_t PACK_FILE[] = {
        // Removing all the zlib data. However, because we do check the trailing checksum,
        // we cannot avoid that to be fed into zlib, causing this to cause an error report from InflateTransform, not from our driver.
        0x50, 0x41, 0x43, 0x4b, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x03, 0x96, 0x0a, /*0x78, 0x9c,
        0x95, 0xcb, 0x41, 0x0a, 0xc2, 0x30, 0x10, 0x00, 0xc0, 0x7b, 0x5e, 0xb1, 0x77, 0x41, 0x76, 0x13,
        0x9b, 0x44, 0x90, 0xe2, 0x1b, 0xda, 0x17, 0x6c, 0x92, 0x8d, 0x06, 0x4c, 0x0b, 0x71, 0x0b, 0x3e,
        0x5f, 0xbf, 0xe0, 0x71, 0x0e, 0xa3, 0x43, 0x04, 0x7c, 0xce, 0xb1, 0x32, 0x95, 0x50, 0xab, 0xad,
        0x94, 0x29, 0x5e, 0x13, 0x5a, 0x2e, 0x89, 0x12, 0x93, 0xb3, 0xd1, 0xa2, 0x43, 0xc9, 0x89, 0xc4,
        0xf0, 0xa1, 0xcf, 0x7d, 0xc0, 0xaa, 0x52, 0x79, 0x83, 0x45, 0x7e, 0x94, 0x01, 0xb7, 0xb7, 0x0e,
        0x39, 0xee, 0x8f, 0xfe, 0x39, 0x17, 0x99, 0x81, 0x82, 0x9f, 0xfc, 0xe4, 0x82, 0xbb, 0xc0, 0x09,
        0x09, 0xd1, 0xe4, 0xbd, 0xf7, 0xa6, 0x2a, 0x7f, 0x47, 0xd3, 0xb6, 0xa6, 0x8d, 0x5f, 0xe6, 0x0b,
        0xf8, 0x90, 0x32, 0xfd, 0x36, 0x78, 0x9c, 0xcb, 0x48, 0xcc, 0xc9, 0xc9, 0xe7, 0x02, 0x00, 0x08,
        0x37, 0x02, 0x1b, 0xa4, 0x02, 0x78, 0x9c, 0x33, 0x34, 0x30, 0x30, 0x33, 0x31, 0x51, 0x28, 0x49,
        0x2d, 0x2e, 0xd1, 0x2b, 0xa9, 0x28, 0x61, 0xf0, 0xf9, 0xba, 0x2a, 0x7e, 0x56, 0x8a, 0x53, 0xf2,
        0xed, 0xc7, 0xd7, 0x9e, 0x77, 0x9f, 0x7e, 0xef, 0xea, 0x51, 0xd5, 0xa0, 0x03, 0x00, 0xfb, 0x44,
        0x0f, 0xfe,*/ 0xd8, 0x3b, 0xf3, 0xbb, 0xe9, 0x2c, 0x48, 0x44, 0x41, 0xe3, 0xd4, 0x9b, 0xfb, 0x57,
        0x6d, 0x67, 0x81, 0x82, 0xea, 0x15
    };

    Ref<InternalDirectory> dir = InternalDirectory::create("dir");
    dir->addStream("xy.pack", *new ConstMemoryStream(PACK_FILE));
    dir->addStream("xy.idx", *new ConstMemoryStream(PLAIN_INDEX_FILE));

    server::file::ca::PackFile testee(*dir, "xy");
    TestRequester req(testee);

    static const ObjectId objId = {{ 0x15, 0xb8, 0x1f, 0xed, 0xbf, 0xef, 0x12, 0x34, 0xab, 0x99, 0xcb, 0xbe, 0x51, 0x0a, 0x10, 0x13, 0xfa, 0x3f, 0xcc, 0x3c, }};
    AFL_CHECK_THROWS(a, testee.getObject(objId, req, 20), std::exception);
}

/** Error case: bad header. */
AFL_TEST("server.file.ca.PackFile:error:bad-header", a)
{
    static const uint8_t PACK_FILE[] = {
        // Wrong version                          vvvv
        0x50, 0x41, 0x43, 0x4b, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03,

        0xd8, 0x3b, 0xf3, 0xbb, 0xe9, 0x2c, 0x48, 0x44, 0x41, 0xe3, 0xd4, 0x9b, 0xfb, 0x57,
        0x6d, 0x67, 0x81, 0x82, 0xea, 0x15
    };

    Ref<InternalDirectory> dir = InternalDirectory::create("dir");
    dir->addStream("xy.pack", *new ConstMemoryStream(PACK_FILE));
    dir->addStream("xy.idx", *new ConstMemoryStream(PLAIN_INDEX_FILE));

    // Construction fails
    AFL_CHECK_THROWS(a, server::file::ca::PackFile(*dir, "xy"), afl::except::FileProblemException);
}

/** Error case: index file too short. */
AFL_TEST("server.file.ca.PackFile:error:too-short", a)
{
    static const uint8_t PACK_FILE[] = {
        // Correct header but nothing else; fails because ID does not fit
        0x50, 0x41, 0x43, 0x4b, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x03,
    };

    Ref<InternalDirectory> dir = InternalDirectory::create("dir");
    dir->addStream("xy.pack", *new ConstMemoryStream(PACK_FILE));
    dir->addStream("xy.idx", *new ConstMemoryStream(PLAIN_INDEX_FILE));

    // Construction fails
    AFL_CHECK_THROWS(a, server::file::ca::PackFile(*dir, "xy"), afl::except::FileProblemException);
}

/** Error case: mismatch of pack/index file ID. */
AFL_TEST("server.file.ca.PackFile:error:mismatch", a)
{
    static const uint8_t PACK_FILE[] = {
        0x50, 0x41, 0x43, 0x4b, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x03, 0x96, 0x0a, 0x78, 0x9c,
        0x95, 0xcb, 0x41, 0x0a, 0xc2, 0x30, 0x10, 0x00, 0xc0, 0x7b, 0x5e, 0xb1, 0x77, 0x41, 0x76, 0x13,
        0x9b, 0x44, 0x90, 0xe2, 0x1b, 0xda, 0x17, 0x6c, 0x92, 0x8d, 0x06, 0x4c, 0x0b, 0x71, 0x0b, 0x3e,
        0x5f, 0xbf, 0xe0, 0x71, 0x0e, 0xa3, 0x43, 0x04, 0x7c, 0xce, 0xb1, 0x32, 0x95, 0x50, 0xab, 0xad,
        0x94, 0x29, 0x5e, 0x13, 0x5a, 0x2e, 0x89, 0x12, 0x93, 0xb3, 0xd1, 0xa2, 0x43, 0xc9, 0x89, 0xc4,
        0xf0, 0xa1, 0xcf, 0x7d, 0xc0, 0xaa, 0x52, 0x79, 0x83, 0x45, 0x7e, 0x94, 0x01, 0xb7, 0xb7, 0x0e,
        0x39, 0xee, 0x8f, 0xfe, 0x39, 0x17, 0x99, 0x81, 0x82, 0x9f, 0xfc, 0xe4, 0x82, 0xbb, 0xc0, 0x09,
        0x09, 0xd1, 0xe4, 0xbd, 0xf7, 0xa6, 0x2a, 0x7f, 0x47, 0xd3, 0xb6, 0xa6, 0x8d, 0x5f, 0xe6, 0x0b,
        0xf8, 0x90, 0x32, 0xfd, 0x36, 0x78, 0x9c, 0xcb, 0x48, 0xcc, 0xc9, 0xc9, 0xe7, 0x02, 0x00, 0x08,
        0x37, 0x02, 0x1b, 0xa4, 0x02, 0x78, 0x9c, 0x33, 0x34, 0x30, 0x30, 0x33, 0x31, 0x51, 0x28, 0x49,
        0x2d, 0x2e, 0xd1, 0x2b, 0xa9, 0x28, 0x61, 0xf0, 0xf9, 0xba, 0x2a, 0x7e, 0x56, 0x8a, 0x53, 0xf2,
        0xed, 0xc7, 0xd7, 0x9e, 0x77, 0x9f, 0x7e, 0xef, 0xea, 0x51, 0xd5, 0xa0, 0x03, 0x00, 0xfb, 0x44,
        0x0f, 0xfe, 0xd8, 0x3b, 0xf3, 0xbb, 0xe9, 0x2c, 0x48, 0x44, 0x41, 0xe3, 0xd4, 0x9b, 0xfb, 0x57,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa  // <-- damaged ID
    };

    Ref<InternalDirectory> dir = InternalDirectory::create("dir");
    dir->addStream("xy.pack", *new ConstMemoryStream(PACK_FILE));
    dir->addStream("xy.idx", *new ConstMemoryStream(PLAIN_INDEX_FILE));

    // Construction fails
    AFL_CHECK_THROWS(a, server::file::ca::PackFile(*dir, "xy"), afl::except::FileProblemException);
}

/*
 *  DeltaExpander special cases
 */

namespace {
    // Make a reference file
    Ref<FileMapping> makeReferenceFile()
    {
        static const uint8_t REF[] = {
            'h','e','l','l','o',' ','w','o','r','l','d'
        };
        afl::base::GrowableBytes_t ref;
        ref.append(REF);
        return *new afl::io::InternalFileMapping(ref);   // will look the GrowableBytes_t
    }

    // Default input
    static const uint8_t DELTA_INPUT[] = {
        11,                     // Reference object size
        12,                     // Output size
        0x01, 'H',              // Add
        0x91, 1, 4,             // Copy
        0x03, ',', ' ', 'W',    // Add
        0x91, 7, 4,             // Copy
    };

    // Default output
    const char DELTA_RESULT[] = "Hello, World";
}

/* DeltaExpander, base case */
AFL_TEST("server.file.ca.PackFile:DeltaExpander:ok", a)
{
    afl::base::GrowableBytes_t out;
    server::file::ca::PackFile::DeltaExpander testee("file", makeReferenceFile(), out);
    testee.acceptBytes(DELTA_INPUT);
    a.checkEqualContent("result", afl::base::ConstBytes_t(out), afl::string::toBytes(DELTA_RESULT));
}

/* Feeding bytewise */
AFL_TEST("server.file.ca.PackFile:DeltaExpander:ok:bytewise", a)
{
    afl::base::GrowableBytes_t out;
    server::file::ca::PackFile::DeltaExpander testee("file", makeReferenceFile(), out);

    afl::base::ConstBytes_t input(DELTA_INPUT);
    while (!input.empty()) {
        testee.acceptBytes(input.split(1));
    }
    a.checkEqualContent("result", afl::base::ConstBytes_t(out), afl::string::toBytes(DELTA_RESULT));
}

/* Feeding bytewise, with empty blocks inbetween */
AFL_TEST("server.file.ca.PackFile:DeltaExpander:ok:bytewise-empty", a)
{
    afl::base::GrowableBytes_t out;
    server::file::ca::PackFile::DeltaExpander testee("file", makeReferenceFile(), out);

    afl::base::ConstBytes_t input(DELTA_INPUT);
    while (!input.empty()) {
        testee.acceptBytes(afl::base::ConstBytes_t());
        testee.acceptBytes(input.split(1));
    }
    a.checkEqualContent("result", afl::base::ConstBytes_t(out), afl::string::toBytes(DELTA_RESULT));
}

/* Feeding too much */
AFL_TEST("server.file.ca.PackFile:DeltaExpander:ok:too-much", a)
{
    afl::base::GrowableBytes_t out;
    server::file::ca::PackFile::DeltaExpander testee("file", makeReferenceFile(), out);

    static const uint8_t INPUT[] = {
        11,                     // Reference object size
        12,                     // Output size
        0x01, 'H',              // Add
        0x91, 1, 4,             // Copy
        0x03, ',', ' ', 'W',    // Add
        0x91, 7, 4,             // Copy
        1, 2, 3, 4, 5           // Extra
    };
    testee.acceptBytes(INPUT);
    a.checkEqualContent("result", afl::base::ConstBytes_t(out), afl::string::toBytes(DELTA_RESULT));
}

/* Error case: invalid reference object size */
AFL_TEST("server.file.ca.PackFile:DeltaExpander:error:bad-size", a)
{
    afl::base::GrowableBytes_t out;
    server::file::ca::PackFile::DeltaExpander testee("file", makeReferenceFile(), out);

    static const uint8_t INPUT[] = {
        15,                     // Wrong reference object size
        12,                     // Output size
        0x01, 'H',              // Add
        0x91, 1, 4,             // Copy
        0x03, ',', ' ', 'W',    // Add
        0x91, 7, 4,             // Copy
    };
    AFL_CHECK_THROWS(a, testee.acceptBytes(INPUT), afl::except::FileProblemException);
}

/* Error case: bad opcode */
AFL_TEST("server.file.ca.PackFile:DeltaExpander:error:bad-opcode", a)
{
    afl::base::GrowableBytes_t out;
    server::file::ca::PackFile::DeltaExpander testee("file", makeReferenceFile(), out);

    static const uint8_t INPUT[] = {
        11,                     // Reference object size
        12,                     // Output size
        0x01, 'H',              // Add
        0x91, 1, 4,             // Copy
        0,                      // Bad opcode
        0x03, ',', ' ', 'W',    // Add
        0x91, 7, 4,             // Copy
    };
    AFL_CHECK_THROWS(a, testee.acceptBytes(INPUT), afl::except::FileProblemException);
}

/* Error case: bad copy offset */
AFL_TEST("server.file.ca.PackFile:DeltaExpander:error:bad-offset", a)
{
    afl::base::GrowableBytes_t out;
    server::file::ca::PackFile::DeltaExpander testee("file", makeReferenceFile(), out);

    static const uint8_t INPUT[] = {
        11,                     // Reference object size
        12,                     // Output size
        0x01, 'H',              // Add
        0x91, 1, 4,             // Copy
        0x03, ',', ' ', 'W',    // Add
        0x91, 77, 4,            // Copy, bad offset
    };
    AFL_CHECK_THROWS(a, testee.acceptBytes(INPUT), afl::except::FileProblemException);
}

/* Error case: bad copy length */
AFL_TEST("server.file.ca.PackFile:DeltaExpander:error:bad-length", a)
{
    afl::base::GrowableBytes_t out;
    server::file::ca::PackFile::DeltaExpander testee("file", makeReferenceFile(), out);

    static const uint8_t INPUT[] = {
        11,                     // Reference object size
        12,                     // Output size
        0x01, 'H',              // Add
        0x91, 1, 4,             // Copy
        0x03, ',', ' ', 'W',    // Add
        0x91, 7, 44,            // Copy, bad length
    };
    AFL_CHECK_THROWS(a, testee.acceptBytes(INPUT), afl::except::FileProblemException);
}
